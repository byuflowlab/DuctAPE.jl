#=
data extracted from cad file from nathan welker
=#

using FLOWMath
using FLOWFoil

inch2meter = 0.0254

function circle(R, center; N=361)
    th = range(pi, 0.0, N)
    x = R * cos.(th) .+ center[1]
    y = R * sin.(th) .+ center[2]

    return x, y
end

#---------------------------------#
#               HUB               #
#---------------------------------#

hub_radius = 0.71555118 #0.015 / inch2meter + 0.125
hub_cyl_start = 1.77480474  #from duct leading edge
hub_cyl_end = 1.43996063  # from cyl start

hub_outlet_length = 1.61023622  # from cyl end to hub tail cone start
hub_outlet_rdiff = 0.09055118
hub_outlet_end_r = 0.625
hub_outlet_r = 14.36237606  #this is the radius of the circular section used to start the hub outlet curve that meets up with the tail cone.
hub_outlet_circ_center = [3.21476537; -13.64682488]  #xr distance from 0,0

hub_tail_cone_length = (1.5 + 0.125)
hub_tail_cone_r = 5.59063986  #this is the radius of the circular section used for the hub cone with line set tangent to outlet circular section.
hub_tail_cone_circ_center = [-2.79494361; -4.84185339]  #xr distance from hub TE

hub_nose_gap = 0.12  #gap between hub cyl start and hub nose cone
hub_nose_cyl_length = 0.5  #cylder portion of nose cone
hub_nose_curve_length = 1.25  # length of curved portion of nose cone
hub_nose_r = 1.44959127  # radius of arc defining curved portion of nose cone
hub_nose_circ_center = [1.25; -0.73404009] # xr distance from hub LE

#---------------------------------#
#           NOSE CONE             #
#---------------------------------#
# get leading edge point
hub_le = hub_cyl_start - hub_nose_gap - hub_nose_cyl_length - hub_nose_curve_length
# get nose cone curvature stop point
nose_cone_end = hub_le + hub_nose_curve_length
# get global position of circle center
hnx = hub_le + hub_nose_circ_center[1]
hnr = hub_nose_circ_center[2]
#get nose cone circle points
xnosecirc, rnosecirc = circle(hub_nose_r, [hnx, hnr])
rnoseidx = findfirst(x -> x >= 0.0, rnosecirc)
xnoseidx = findlast(x -> x <= nose_cone_end, xnosecirc)

#nose cone coordinates
xnose = xnosecirc[rnoseidx:xnoseidx]
rnose = rnosecirc[rnoseidx:xnoseidx]

#---------------------------------#
#             CYLINDER            #
#---------------------------------#

#update hub radius since it's close, but not perfect
# mod_hub_radius = maximum(rnose)
#update cylinder starting location
# cyl_start = maximum(xnose)
cyl_end = hub_cyl_end + hub_cyl_start

#---------------------------------#
#              OUTLET             #
#---------------------------------#

## get global center coordinates
hox = hub_outlet_circ_center[1]
hor = hub_outlet_circ_center[2]
#get raw circle coordinates
xoutcirc, routcirc = circle(hub_outlet_r, [hox; hor])
# rmax, ridx = findmax(routcirc)
#rshift = rmax-mod_hub_radius
#xshift = xoutcirc[ridx] - cyl_end

##shift to match well
## routcirc .+= rshift
## xoutcirc .-= xshift
##trim things up
xocidx = findfirst(x -> x >= cyl_end, xoutcirc)
## rocidx = findlast(x->x>cyl_end+hub_outlet_length,xoutcirc)
rocidx = findlast(x -> x >= hub_outlet_end_r, routcirc)
xoutlet = xoutcirc[xocidx:rocidx]
routlet = routcirc[xocidx:rocidx]

#---------------------------------#
#            tail cone           #
#---------------------------------#

# get global center coordinates
htx = hub_tail_cone_circ_center[1] + hub_te
htr = hub_tail_cone_circ_center[2]
#get raw circle coordinates
xtcirc, rtcirc = circle(hub_tail_cone_r, [htx; htr])
#trim things up
rtcidx1 = findfirst(x -> x > xoutlet[end], xtcirc)
rtcidx2 = findlast(x -> x >= 0.0, rtcirc) - 1
xtail = xtcirc[rtcidx1:rtcidx2]
rtail = rtcirc[rtcidx1:rtcidx2]
rshift = rtail[1] - routlet[end]
rtail .-= rshift

#---------------------------------#
#         putting together        #
#---------------------------------#

hubx_pieces = [xnose; hub_cyl_start; cyl_end; xoutlet; xtail]
hubr_pieces = [rnose; hub_radius; hub_radius; routlet; rtail]

function scaled_cosine_spacing(N, scale, transform; mypi=pi)
    return transform .+ scale * [0.5 * (1 - cos(mypi * (i - 1) / (N - 1))) for i in 1:N]
end

hubx = scaled_cosine_spacing(180, hubx_pieces[end]-hubx_pieces[1], hubx_pieces[1])
hubr = FLOWMath.akima(hubx_pieces, hubr_pieces, hubx)

### PLOT if you want
using Plots
plot(; aspectratio=1)
plot!(xnose, rnose)
plot!([hub_cyl_start; cyl_end], [hub_radius; hub_radius])
plot!(xoutlet, routlet)
plot!(xtail, rtail)
plot!(hubx,hubr, linestyle=:dot, linewidth=2)
gui()

#---------------------------------#
#               DUCT              #
#---------------------------------#

duct_coordinates = [
    5.0 2.35
    4.999518101205162 2.350048187275464
    4.998072590601808 2.35019269157818
    4.99566402546179 2.350433340450674
    4.99229333433282 2.3507698468420304
    4.9879618166804915 2.3512018096741825
    4.982671142387316 2.351728714632664
    4.976423351108943 2.352349935179796
    4.969220851487845 2.3530647337876727
    4.9610664202247285 2.3538722599752973
    4.951963201008076 2.354771542488582
    4.941914703302181 2.3557615123614712
    4.930924800994191 2.356840996853378
    4.918997730900649 2.3580086866087266
    4.9061380911341175 2.3592631823357793
    4.892350839330522 2.3606030013837422
    4.877641290737884 2.362026502968329
    4.8620151161671945 2.363532002555659
    4.845478339806211 2.365117662212211
    4.828037336897008 2.3667815878863547
    4.809698831278217 2.3685217451284983
    4.7904698927928395 2.370336050139962
    4.770357934562703 2.372222268896572
    4.749370710130554 2.3741781357400837
    4.72751631047092 2.3762012467532467
    4.704803160870887 2.3782891202587195
    4.681240017681993 2.3804392186936454
    4.65683596494448 2.3826488855766392
    4.6316004108852304 2.384915387265926
    4.605543084290717 2.387235931432327
    4.578674030756362 2.389607645196217
    4.551003608813784 2.392027572150572
    4.522542485937368 2.3944926887094438
    4.493301634431768 2.3969999061825233
    4.463292327201862 2.3995460730781857
    4.432526133406841 2.4021279776323716
    4.401014914000077 2.4047423506300754
    4.368770817156491 2.407385868277713
    4.335806273589214 2.4100551549313196
    4.302133991757297 2.4127467877657773
    4.267766952966369 2.4154572992935965
    4.232718406364089 2.4181831812390167
    4.197001863832353 2.420920888813929
    4.160631094778204 2.4236668447597123
    4.123620120825459 2.426417443669934
    4.085983210409115 2.429169056473335
    4.047734873274584 2.431918035067053
    4.008889854883929 2.434660713597545
    3.9694631307311825 2.4373933951493307
    3.92946990056903 2.4401123909401057
    3.8889255825490054 2.4428140157202356
    3.8478458072774995 2.4454945804533894
    3.806246411789872 2.448150369343639
    3.7641434334449606 2.450777712473066
    3.7215531037423877 2.4533729556026436
    3.6784918420649944 2.4559324151287196
    3.634976249348867 2.4584524825352365
    3.591023101683355 2.460929555628369
    3.54664934384357 2.4633600410002643
    3.5018720827578527 2.465740436038179
    3.456708580912724 2.4680672065527007
    3.411176249697874 2.4703369420303907
    3.3652926426937317 2.472546205088419
    3.3190754489042336 2.474691688870581
    3.2725424859373686 2.476770071429043
    3.225711693136156 2.4787781726850966
    3.178601124662686 2.4807128023414617
    3.131228942537895 2.482570925816626
    3.083613409639763 2.484349512964069
    3.0357728826626262 2.4860456749996676
    2.9877258050403204 2.4876565876930803
    2.9394906998358863 2.4891795010267446
    2.891086162600576 2.490611822372236
    2.84253085420492 2.491950998026647
    2.793843493644594 2.4931946146486785
    2.7450428508239018 2.494340390565268
    2.696147739319612 2.495386112675554
    2.6471770091279727 2.4963297266621596
    2.598149539397671 2.4971693148795113
    2.5490842311515705 2.4979030508689344
    2.4999999999999996 2.498529264372946
    2.450915768848429 2.499046454726695
    2.4018504606023283 2.49945322297155
    2.3528229908720273 2.4997483205584237
    2.3038522606803875 2.4999307634594485
    2.2549571491760982 2.499996599348409
    2.2061565063554056 2.5
    2.1574691457950794 2.5
    2.1089138373994225 2.5000000000000004
    2.0605093001641137 2.5
    2.012274194959679 2.5
    1.9642271173373733 2.5
    1.9163865903602362 2.5
    1.8687710574621046 2.5
    1.8213988753373143 2.5000000000000004
    1.7742883068638438 2.5
    1.7274575140626314 2.5000102554577537
    1.6809245510957664 2.5001011563760085
    1.6347073573062676 2.5002789608411398
    1.588823750302126 2.500555898531059
    1.5432914190872755 2.500927507869304
    1.4981279172421471 2.5013973972019063
    1.4533506561564296 2.5019666605248077
    1.4089768983166446 2.502637266569546
    1.365023750651133 2.50341126220926
    1.321508157935006 2.504290677341012
    1.2784468962576125 2.5052770609738038
    1.2358565665550385 2.5063715062271625
    1.1937535882101278 2.5075758688583747
    1.152154192722499 2.50889199895524
    1.1110744174509943 2.5103217251658383
    1.070530099430969 2.5118667457570254
    1.030536869268817 2.513527903853841
    0.9911101451160718 2.515306663227912
    0.9522651267254151 2.5172046556738397
    0.9140167895908863 2.5192234861041296
    0.8763798791745405 2.521364734421767
    0.8393689052217956 2.5236299404605935
    0.8029981361676455 2.5260198783480887
    0.7672815936359101 2.5285355662697544
    0.7322330470336311 2.5311783651592648
    0.697866008242703 2.5339496039449476
    0.6641937264107861 2.5368505815177143
    0.6312291828435079 2.5398825693156817
    0.5989850859999226 2.543046814694251
    0.5674738665931576 2.5463442384771104
    0.5367076727981377 2.5497751767071977
    0.5066983655682322 2.5533406138033437
    0.47745751406263137 2.557041535847911
    0.44899639118621604 2.5608788934480886
    0.4213259692436369 2.564853604654254
    0.39445691570928365 2.5689665589404536
    0.3683995891147693 2.573218622625249
    0.3431640350555204 2.5776106462677224
    0.31875998231800706 2.5821433034779684
    0.2951968391291124 2.5868163801095028
    0.27248368952908025 2.5916302967168945
    0.2506292898694462 2.59658556931546
    0.2296420654372966 2.6016826719813224
    0.2095301072071601 2.6069220406329703
    0.19030116872178315 2.6123040788016776
    0.17196266310299108 2.617829166472609
    0.1545216601937896 2.6234976737626496
    0.13798488383280488 2.6293099823879564
    0.12235870926211617 2.635266519993961
    0.10764916066947794 2.641367816332227
    0.0938619088658818 2.647613990319127
    0.0810022690993506 2.654003592468156
    0.06907519900580861 2.660536388111821
    0.05808529669781903 2.667212191735369
    0.048036798991923924 2.6740307412061166
    0.03893357977527101 2.6809916870459705
    0.030779148512155574 2.6880945760761796
    0.023576648891056873 2.6953388269002008
    0.017328857612684267 2.7027236968990525
    0.012038183319507678 2.7102482602633597
    0.00770666566718009 2.717911544239677
    0.004335974538210163 2.725713830022906
    0.0019274093981927476 2.733567404122114
    0.00048189879483795384 2.7417960597358304
    0.0 2.75
    0.00048189879483795384 2.756774439484694
    0.0019274093981927476 2.7637109329438667
    0.004335974538210163 2.770689774321822
    0.00770666566718009 2.777847446386659
    0.012038183319507678 2.785056481998784
    0.017328857612684267 2.792377646364456
    0.023576648891056873 2.7997624595214705
    0.030779148512155574 2.8072265093893636
    0.03893357977527101 2.814746698919378
    0.048036798991923924 2.8223212273065585
    0.05808529669781903 2.829938847936462
    0.06907519900580861 2.8375889458134065
    0.0810022690993506 2.8452661406704114
    0.0938619088658818 2.8529563570972067
    0.10764916066947794 2.8606557235045487
    0.12235870926211617 2.8683497620533465
    0.13798488383280488 2.876034143084155
    0.1545216601937896 2.8836952578824246
    0.17196266310299108 2.891327620419347
    0.19030116872178315 2.8989189686639416
    0.2095301072071601 2.9064624390245437
    0.2296420654372966 2.913947294115907
    0.2506292898694462 2.9213652510035986
    0.27248368952908025 2.928707123056567
    0.2951968391291124 2.935963358009875
    0.31875998231800706 2.943126041997238
    0.3431640350555204 2.950184984008465
    0.3683995891147693 2.957132880300265
    0.39445691570928365 2.9639595450729184
    0.4213259692436369 2.9706577877976525
    0.44899639118621604 2.977217917588711
    0.47745751406263137 2.983632492152622
    0.5066983655682322 2.989892704565841
    0.5367076727981377 2.9959905708456827
    0.5674738665931576 3.00191837694614
    0.5989850859999226 3.0076677178484403
    0.6312291828435079 3.0132316980808387
    0.6641937264107861 3.0186020053118257
    0.697866008242703 3.023772043486929
    0.7322330470336311 3.0287341399188192
    0.7672815936359101 3.033481542608401
    0.8029981361676455 3.038007593781218
    0.8393689052217956 3.0423053281448595
    0.8763798791745405 3.046368938217372
    0.9140167895908863 3.0501917772589238
    0.9522651267254151 3.053768272832614
    0.9911101451160718 3.0570926690054754
    1.030536869268817 3.060159283999064
    1.070530099430969 3.062963317935282
    1.1110744174509943 3.065499462607456
    1.152154192722499 3.067763190074718
    1.1937535882101278 3.069750140401914
    1.2358565665550385 3.0714558801768397
    1.2784468962576125 3.0728768158818105
    1.321508157935006 3.074009214533239
    1.365023750651133 3.074849612067427
    1.4089768983166446 3.0753952282054553
    1.4533506561564296 3.075643166124969
    1.4981279172421471 3.075590902226341
    1.5432914190872755 3.0752364975984925
    1.588823750302126 3.0745779904867354
    1.6347073573062676 3.073613774889933
    1.6809245510957664 3.072342805622836
    1.7274575140626314 3.0707641113617212
    1.7742883068638438 3.0688770221221753
    1.8213988753373143 3.0666813793020515
    1.8687710574621046 3.064177259196284
    1.9163865903602362 3.0613649802677685
    1.9642271173373733 3.058245231126025
    2.012274194959679 3.054819147706704
    2.0605093001641137 3.05108807070986
    2.1089138373994225 3.0470536603521743
    2.1574691457950794 3.0427179275726406
    2.2061565063554056 3.038083290272335
    2.2549571491760982 3.0331524245515333
    2.3038522606803875 3.0279283207728493
    2.3528229908720273 3.0224143035015616
    2.4018504606023283 3.016614035500404
    2.450915768848429 3.0105315352789206
    2.4999999999999996 3.0041711025524767
    2.5490842311515705 2.997537352203491
    2.598149539397671 2.9906352175941455
    2.6471770091279727 2.983469946243831
    2.696147739319612 2.9760470952574325
    2.7450428508239018 2.9683725313620966
    2.793843493644594 2.9604524201686386
    2.84253085420492 2.9522932123676133
    2.891086162600576 2.9439016485383442
    2.9394906998358863 2.935284753267515
    2.9877258050403204 2.926449828870149
    3.0357728826626262 2.9174044488245228
    3.083613409639763 2.9081564509160445
    3.131228942537895 2.89871393008496
    3.178601124662686 2.8890852309725523
    3.225711693136156 2.8792789401603547
    3.2725424859373686 2.8693038780967077
    3.3190754489042336 2.85916909070482
    3.3652926426937317 2.848883840666322
    3.411176249697874 2.838457598374139
    3.456708580912724 2.8279000325483303
    3.5018720827578527 2.8172210005084053
    3.54664934384357 2.806430538095453
    3.591023101683355 2.7955388492373023
    3.634976249348867 2.784556295149779
    3.6784918420649944 2.773493383167565
    3.7215531037423877 2.7623607607287646
    3.7641434334449606 2.7511692027271195
    3.806246411789872 2.739929592992046
    3.8478458072774995 2.728652915044854
    3.8889255825490054 2.7173502391700746
    3.92946990056903 2.706032709164233
    3.9694631307311825 2.6947115532526196
    4.008889854883929 2.683398052898105
    4.047734873274584 2.6721035092889904
    4.085983210409115 2.6608392427629073
    4.123620120825459 2.6496166109384696
    4.160631094778204 2.6384469961645802
    4.197001863832353 2.627341716089695
    4.232718406364089 2.616312062152986
    4.267766952966369 2.6053693673666283
    4.302133991757297 2.5945248354049415
    4.335806273589214 2.58378959307699
    4.368770817156491 2.573174796180537
    4.401014914000077 2.5626913867179275
    4.432526133406841 2.5523502611278683
    4.463292327201862 2.5421622345489427
    4.493301634431768 2.532137875072742
    4.522542485937368 2.522287777269495
    4.551003608813784 2.512622189185443
    4.578674030756362 2.5031513825117924
    4.605543084290717 2.4938852595164707
    4.6316004108852304 2.484833716423917
    4.65683596494448 2.4760062512024046
    4.681240017681993 2.4674123483950985
    4.704803160870887 2.459061048448387
    4.72751631047092 2.45096136155749
    4.749370710130554 2.4431218703660527
    4.770357934562703 2.43555098923928
    4.7904698927928395 2.4282568927463415
    4.809698831278217 2.421247321197724
    4.828037336897008 2.414529885154208
    4.845478339806211 2.4081118415101317
    4.8620151161671945 2.4020000382431497
    4.877641290737884 2.396201129858925
    4.892350839330522 2.3907214294214314
    4.9061380911341175 2.3855668232650777
    4.918997730900649 2.3807428898248904
    4.930924800994191 2.3762548803444323
    4.941914703302181 2.3721076817445885
    4.951963201008076 2.3683058066697487
    4.9610664202247285 2.3648533894510253
    4.969220851487845 2.361754195229947
    4.976423351108943 2.359011604841729
    4.982671142387316 2.3566286105515157
    4.9879618166804915 2.354607812620834
    4.99229333433282 2.3529514163270644
    4.99566402546179 2.3516612294379864
    4.998072590601808 2.3507386601431373
    4.999518101205162 2.3501847154434143
    5.0 2.35
]
